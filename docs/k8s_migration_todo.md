# QAHub Kubernetes 迁移前待办清单

> 目标：在将 QAHub 从当前的 docker-compose 部署迁移到 Kubernetes 之前，补齐必须的治理与工程能力，降低上线风险。以下条目均基于当前仓库代码与配置的实际情况（最后审阅时间：2025-10-09）。

## 服务与容器镜像

| 待办                | 现状 / 证据                                                                                                                                          | 建议动作                                                                             | 优先级 |
| ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | ------ |
| 对齐容器暴露端口    | 各服务 Dockerfile 暴露 `808x`（例如 `cmd/user-service/Dockerfile` 的 `EXPOSE 8081`），但 gRPC 实际监听 `config.services.*.grpc_port`（5005x 端口）。 | 修正 Dockerfile 暴露端口或在容器内新增 HTTP 监听，确保与 Kubernetes `Service` 对应。 | 高     |
| 明确镜像运行用户    | 运行时镜像基于 `alpine:latest` 且默认 root。                                                                                                         | 在 Dockerfile 中创建非 root 用户，配合 Kubernetes `securityContext`。                | 中     |
| 杜绝 latest 标签    | `compose.yml` 中 Kafka 使用 `apache/kafka:latest`。                                                                                                  | 在镜像构建 & 部署流程中锁定版本，保证集群可重复。                                    | 中     |
| 编译产物签名与 SBOM | 当前仅 `go build`。                                                                                                                                  | 在构建流程生成 SBOM/签名，满足供应链安全要求。                                       | 中     |

## 配置与密钥管理

| 待办                 | 现状 / 证据                                                          | 建议动作                                                                             | 优先级 |
| -------------------- | -------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | ------ |
| 切分配置与密钥       | `configs/config.docker.yaml` 内含数据库、Kafka、MongoDB 等明文凭据。 | 将非敏感配置抽到 ConfigMap，敏感项放入 Secret，更新 `pkg/config.Init` 支持多源合并。 | 高     |
| 标准化环境变量覆盖   | 目前仅通过 `viper.AutomaticEnv()` 支持扁平覆盖，需要严格的命名约定。 | 定义统一的环境变量前缀/模板，并在文档中列出所有可覆盖项。                            | 中     |
| 运行时配置热加载策略 | 服务启动后不再读取配置。                                             | 评估是否需要热加载；若需要，利用 viper Watch 或重启策略。                            | 低     |

## 应用改造

| 待办           | 现状 / 证据                                                                            | 建议动作                                                                                         | 优先级 |
| -------------- | -------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ | ------ |
| 优雅停机       | `cmd/*/main.go` 仅创建 `context.WithCancel`，未订阅 `SIGTERM`。                        | 引入 `signal.NotifyContext`，让 K8s 的 `preStop`/`terminationGracePeriodSeconds` 生效。          | 高     |
| 健康探针       | 各 gRPC 服务未注册 `grpc/health`，也无 HTTP `/healthz`。                               | 实现 gRPC Health Checking Protocol，并包装 HTTP 适配（供 `grpc-health-probe` 和 K8s 探针使用）。 | 高     |
| 观测性         | 仅使用 `log.Printf`，无指标/分布式追踪。                                               | 集成 Prometheus 指标（`promauto`），规划 OpenTelemetry exporter，增强日志字段。                  | 中     |
| 超时与重试治理 | 服务内部数据库/Redis 操作多处缺乏 context timeout。                                    | 收敛为集中配置（例如 `config.services.*` 中增加超时设置），并在客户端统一重试策略。              | 中     |
| gRPC 访问控制  | QA 服务通过 `config.Services.Gateway.UserServiceEndpoint` 访问用户服务，耦合网关配置。 | 将跨服务地址拆分为独立配置项（或使用服务发现/env），避免循环依赖。                               | 中     |
| TLS 准备       | 当前 gRPC 均使用 insecure 连接。                                                       | 预留支持 mTLS 的配置（证书位置、启用开关）。                                                     | 中     |

## 数据与状态依赖

| 待办           | 现状 / 证据                                                                          | 建议动作                                                          | 优先级 |
| -------------- | ------------------------------------------------------------------------------------ | ----------------------------------------------------------------- | ------ |
| 数据库迁移策略 | docker-compose 中使用 `migrate/migrate` 临时容器（`compose.yml` 的 `db-migrator`）。 | 在 K8s 中改造成一次性 Job，确保幂等并与服务启动顺序解耦。         | 高     |
| 数据持久化     | MySQL、Redis、Kafka、Elasticsearch、Mongo 均依赖本地卷。                             | 规划使用托管服务或 StatefulSet+PVC 的持久化方案，并制定备份策略。 | 高     |
| 种子数据/脚本  | `scripts/seed_data.go` 未纳入部署流程。                                              | 评估是否需要 Job/InitContainer 注入初始数据。                     | 低     |

## 平台与网络

| 待办             | 现状 / 证据                                                  | 建议动作                                                                    | 优先级 |
| ---------------- | ------------------------------------------------------------ | --------------------------------------------------------------------------- | ------ |
| Ingress 设计     | 目前存在 Nginx 配置但未启用（compose 中注释）。              | 确定在 K8s 使用 Gateway API / Ingress Controller 的统一方案，以及鉴权链路。 | 中     |
| Service DNS 命名 | 配置文件硬编码 `user-service:50051` 等 Docker Compose 名称。 | 迁移时对齐为 `<svc>.<namespace>.svc.cluster.local`，或改用环境变量注入。    | 高     |
| 内外网分离       | Kafka/Elasticsearch 暴露 NodePort/Host 端口。                | 利用 LoadBalancer / Ingress 规划内外网访问策略，配合 NetworkPolicy。        | 中     |

## CI/CD 与交付

| 待办       | 现状 / 证据                                         | 建议动作                                                                                | 优先级 |
| ---------- | --------------------------------------------------- | --------------------------------------------------------------------------------------- | ------ |
| 构建流水线 | 目前仅手动 `docker-compose build`。                 | 建立 CI（如 GitHub Actions）构建并推送镜像，生成 Helm/Manifest 工件。                   | 高     |
| 部署模板   | 仓库暂无 K8s manifests / Helm chart。               | 产出基础模板（Deployment, Service, HPA, ConfigMap, Secret, Job 等），并文档化覆盖方式。 | 高     |
| 自动化测试 | `pkg/auth/token_test.go` 等局部单测，缺少集成测试。 | 在 CI 中执行单测，并补充 contract / e2e 测试确保服务间契约。                            | 中     |

## 安全与合规

| 待办          | 现状 / 证据                | 建议动作                                                       | 优先级 |
| ------------- | -------------------------- | -------------------------------------------------------------- | ------ |
| 凭据轮换      | 所有密码硬编码为弱口令。   | 引入 Secret 管理并制定轮换流程。                               | 高     |
| RBAC 最小权限 | 服务账户与 RBAC 策略缺失。 | 设计命名空间、ServiceAccount、Role/RoleBinding，限制访问范围。 | 中     |
| 依赖漏洞管理  | 依赖更新无自动监控。       | 接入 Dependabot/Trivy 等扫描。                                 | 中     |

## 交付成果与文档

- ✅ 本清单文件：`docs/k8s_migration_todo.md`
- ☐ Kubernetes 部署指引文档（待产出）
- ☐ 各服务运行手册与告警手册（待补充）

> 建议在迭代过程中维护此清单，完成后将对应项标记并关联变更记录，以便审计与回顾。
