upstream user_service {
    server user-service:8081;
}

upstream qa_service {
    server qa-service:8082;
}

upstream search_service {
    server search-service:8083;
}

server {
    listen 80;
    server_name localhost;

    # 认证子请求的 location
    location = /_auth {
        internal;
        proxy_pass http://user-service:8081/api/v1/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Authorization $http_authorization;
    }

    # 代理到 user-service 的公开接口 (login, register)
    location ~ ^/api/v1/users/(login|register) {
        # 对于 OPTIONS 请求，直接通过（用于 CORS 预检）
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Allow-Credentials "true" always;
            return 204;
        }
        
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 代理到 qa-service 的公开 GET 接口
    location ~ ^/api/v1/(questions|answers|comments) {
        # 对于 OPTIONS 请求，直接通过（用于 CORS 预检）
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Allow-Credentials "true" always;
            return 204;
        }
        
        if ($request_method != GET) {
            rewrite ^ /_protected_qa$request_uri last;
        }
        proxy_pass http://qa_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 内部命名 location，用于处理需要认证的 qa-service 请求
    location ~ ^/_protected_qa/api/v1/(questions|answers|comments) {
        internal;
        
        # 对于 OPTIONS 请求，直接通过（用于 CORS 预检）
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Allow-Credentials "true" always;
            return 204;
        }
        
        auth_request /_auth;
        auth_request_set $auth_user_id $upstream_http_x_user_id;
        proxy_set_header X-User-ID $auth_user_id;

        proxy_pass http://qa_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    # 代理到 search-service 的搜索接口
    location ~ ^/api/v1/search {
        # 对于 OPTIONS 请求，直接通过（用于 CORS 预检）
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Allow-Credentials "true" always;
            return 204;
        }
        
        proxy_pass http://search_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 默认处理其他 user-service 的需要认证的接口
    location /api/v1/ {
        # 对于 OPTIONS 请求，直接通过（用于 CORS 预检）
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Allow-Credentials "true" always;
            return 204;
        }
        
        auth_request /_auth;
        auth_request_set $auth_user_id $upstream_http_x_user_id;
        proxy_set_header X-User-ID $auth_user_id;

        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location / {
        return 200 'Welcome to QAHub API Gateway';
    }
}
